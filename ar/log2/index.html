<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://aframe.io/releases/1.0.1/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.5.0/aframe/build/aframe-ar.js"></script>
    <title>Sample Web App</title>

    <script>
      var count = 0;
      let os;

      AFRAME.registerComponent('test-camera', {
        init: function() {
        //初期化時に呼ばれる
          console.log('初期化');

        // OSを取得
          os = detectOS();

          if (os == "iphone") {
          // iOSの場合
            if (typeof DeviceOrientationEvent.requestPermission === "function") {
            // ユーザーの許可を得る
              DeviceOrientationEvent.requestPermission().then(res => {
                if (res === "granted") {
              //許可された
//                  confirm('ジャイロセンサーが動作しました。(iPhone)');

                  window.addEventListener("deviceorientation", detectDirection);
                }
                else {
                //許可されなかった
                  confirm('ジャイロセンサー検知できませんでした。(iPhone)');
                }
              });
              window.addEventListener("deviceorientation", orientation, true);
            }
            else {
              confirm('iOS13以降のみジャイロに対応しています。ジャイロは動作しません。');
            }
          }
          else if (os == "android") {
            window.addEventListener("deviceorientationabsolute", orientation, true);
          }
          else {
            confirm('非対応デバイス');
          }
        }
      });

      function detectOS() {
        let ret;
        if ((navigator.userAgent.indexOf("iPhone") > 0) ||
            (navigator.userAgent.indexOf("iPad") > 0) ||
            (navigator.userAgent.indexOf("iPod") > 0)) {
            ret = "iphone";
        }
        else if (navigator.userAgent.indexOf("Android") > 0) {
            ret = "android";
        }
        else {
            ret = "pc";
        }

        return ret;
      }

      function orientation(event) {
        let degrees;

        if (os == "iphone") {
        // webkitCompasssHeading値を使用
          degrees = event.webkitCompassHeading;
        }
        else {
          degrees = compassHeading(event.alpha, event.beta, event.gamma);
        }
        document.querySelector("#degree_text").innerHTML = "Degree = " + degrees;
      }

      // 端末の傾き補正（Android用）
      function compassHeading(alpha, beta, gamma) {
        var degtorad = Math.PI / 180; // Degree-to-Radian conversion

        var _x = beta ? beta * degtorad : 0; // beta value
        var _y = gamma ? gamma * degtorad : 0; // gamma value
        var _z = alpha ? alpha * degtorad : 0; // alpha value

        var cX = Math.cos(_x);
        var cY = Math.cos(_y);
        var cZ = Math.cos(_z);
        var sX = Math.sin(_x);
        var sY = Math.sin(_y);
        var sZ = Math.sin(_z);

        // Calculate Vx and Vy components
        var Vx = -cZ * sY - sZ * sX * cY;
        var Vy = -sZ * sY + cZ * sX * cY;

        // Calculate compass heading
        var compassHeading = Math.atan(Vx / Vy);

        // Convert compass heading to use whole unit circle
        if (Vy < 0) {
            compassHeading += Math.PI;
        } else if (Vx < 0) {
            compassHeading += 2 * Math.PI;
        }

        return compassHeading * (180 / Math.PI); // Compass Heading (in degrees)
      }
    </script>

  </head>
  <body>
    <a-scene>
      <!--枠1--> <!--カメラに追従させる-->
        <!--右-->
        <a-box position="10.75 0 -25" color="#deb887" scale="7.5 29 1"></a-box>
        <!--左-->
        <a-box position="-10.75 0 -25" color="#deb887" scale="7.5 29 1"></a-box>
        <!--上-->
        <a-box position="0 10.75 -25" color="#deb887" scale="14 7.5 1"></a-box>
        <!--下-->
        <a-box position="0 -10.75 -25" color="#deb887" scale="14 7.5 1"></a-box>

      <!--中心点-->  <!--カメラに追従させない-->
      <!--<a-box position="0 0 -18" color="#dc143c" scale="0.5 0.5 0.5"></a-box>-->

      <!--カメラ-->
      <a-camera position="0 0 0" cursor-visible="true" cursor-scale="2" cursor-color="#0095DD" cursor-opacity="0.5" test-camera></a-camera>
      <!-- <a-box position="5 0 -7" rotation="0 45 0" color="#4CC3D9"></a-box>
      <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
      <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder> -->
    </a-scene>
    <!--中央点-->
    <div id="center_point" style="margin: 0;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-right: -50%;
      color: #ff0000;
      font-size: 50px;
      transform: translate(-50%, -50%) ">●
    </div>
    <div id="degree_text" style="margin: 0;
      position: absolute;
      top: 10%;
      left: 10%;
      color: #FFFFFF;
      font-size: 20px">Degree = </div>
  </body>
</html>